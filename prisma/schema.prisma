generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String               @id
  name               String?
  email              String               @unique
  password           String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  role               Role                 @default(BUYER)
  authProvider       AuthProvider         @default(EMAIL)
  avatar             String?
  emailVerified      Boolean              @default(false)
  providerId         String?
  resetToken         String?              @unique
  resetTokenExpiry   DateTime?
  verificationExpiry DateTime?
  verificationToken  String?              @unique
  phone              String?              @unique
  addresses          Address[]
  favorites          Favorite[]
  EmailLogOTPs       EmailLogOTP[]
  inventory_items    inventory_items[]
  kitchens           Kitchen[]
  menu_items         menu_items[]
  notifications      Notification[]
  orders             Order[]
  reviews            Review[]
  supportTickets     SupportTicket[]
  user_subscriptions user_subscriptions[]

  @@map("users")
}

model Address {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  label            String
  address          String
  zone             String?
  latitude         Float?
  longitude        Float?
  isDefault        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isKitchenAddress Boolean  @default(false) @map("is_kitchen_address")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  kitchen          Kitchen?

  @@index([userId])
  @@index([latitude, longitude])
  @@index([isKitchenAddress])
  @@map("addresses")
}

model EmailLogOTP {
  id        Int      @id @default(autoincrement())
  otp       String
  createdAt DateTime @default(now())
  expiresAt DateTime
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("forget_password_otps")
}

model ingredients {
  id           String     @id @default(cuid())
  menu_item_id String
  name         String
  quantity     Float
  unit         String
  cost         Float?
  createdAt    DateTime   @default(now())
  menu_items   menu_items @relation(fields: [menu_item_id], references: [id], onDelete: Cascade)

  @@index([menu_item_id])
}

model menu_item_images {
  id           String     @id @default(cuid())
  menu_item_id String
  imageUrl     String
  order        Int        @default(0)
  createdAt    DateTime   @default(now())
  menu_items   menu_items @relation(fields: [menu_item_id], references: [id], onDelete: Cascade)

  @@index([menu_item_id])
}

model menu_items {
  id               String             @id @default(cuid())
  chef_id          String
  name             String
  description      String?
  category         String
  price            Float
  prepTime         Int?
  calories         Int?
  spiciness        String?
  isVegetarian     Boolean            @default(false)
  isAvailable      Boolean            @default(true)
  allergyAlerts    String[]           @default([])
  rating           Float?             @default(0)
  reviewCount      Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  favorites        Favorite[]
  ingredients      ingredients[]
  menu_item_images menu_item_images[]
  users            User               @relation(fields: [chef_id], references: [id], onDelete: Cascade)
  orderItems       OrderItem[]
  reviews          Review[]

  @@index([chef_id])
}

model Kitchen {
  id                  String               @id @default(cuid())
  sellerId            String               @map("seller_id")
  name                String
  type                String?
  description         String?
  location            String?
  area                String?
  distance            Float?
  nidName             String?
  nidFrontImage       String?
  nidBackImage        String?
  onboardingCompleted Boolean              @default(false)
  isVerified          Boolean              @default(false)
  isActive            Boolean              @default(true)
  isOpen              Boolean              @default(true)
  coverImage          String?
  profileImage        String?
  kriScore            Int                  @default(0)
  rating              Decimal?             @default(0) @db.Decimal(3, 2)
  reviewCount         Int                  @default(0)
  totalOrders         Int                  @default(0)
  totalRevenue        Decimal?             @default(0) @db.Decimal(10, 2)
  satisfactionRate    Decimal?             @db.Decimal(3, 2)
  responseTime        Int?
  deliveryRate        Decimal?             @db.Decimal(3, 2)
  operatingDays       Json?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  addressId           String?              @unique @map("address_id")
  latitude            Float?
  longitude           Float?
  max_capacity        Int                  @default(6)
  breakfast_capacity  Int?                 @map("breakfast_capacity")
  lunch_capacity      Int?                 @map("lunch_capacity")
  snacks_capacity     Int?                 @map("snacks_capacity")
  dinner_capacity     Int?                 @map("dinner_capacity")
  min_prep_time_hours Int                  @default(4)
  favorites           Favorite[]
  gallery             KitchenGallery[]
  address             Address?             @relation(fields: [addressId], references: [id])
  seller              User                 @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  notifications       Notification[]
  orders              Order[]
  subscription_plans  subscription_plans[]
  user_subscriptions  user_subscriptions[]

  @@index([sellerId])
  @@index([addressId])
  @@map("kitchens")
}

model KitchenGallery {
  id        String   @id @default(cuid())
  kitchenId String   @map("kitchen_id")
  imageUrl  String   @map("image_url")
  order     Int      @default(0)
  createdAt DateTime @default(now())
  kitchen   Kitchen  @relation(fields: [kitchenId], references: [id], onDelete: Cascade)

  @@index([kitchenId])
  @@map("kitchen_gallery")
}

model subscription_plans {
  id                 String               @id @default(cuid())
  kitchen_id         String               @map("kitchen_id")
  name               String
  description        String?
  price              Float
  meals_per_day      Int                  @default(1)
  servings_per_meal  Int                  @default(1)
  is_active          Boolean              @default(true)
  subscriber_count   Int                  @default(0)
  monthly_revenue    Float                @default(0)
  rating             Decimal?             @default(0) @db.Decimal(3, 2)
  cover_image        String?              @map("cover_image")
  calories           Int?
  protein            String?
  carbs              String?
  fats               String?
  chef_quote         String?              @map("chef_quote")
  created_at         DateTime             @default(now()) @map("created_at")
  updated_at         DateTime             @updatedAt @map("updated_at")
  weekly_schedule    Json                 @default("{}") @map("weekly_schedule")
  favorites          Favorite[]
  kitchen            Kitchen              @relation(fields: [kitchen_id], references: [id], onDelete: Cascade)
  user_subscriptions user_subscriptions[]

  @@index([kitchen_id])
  @@map("subscription_plans")
}

model Order {
  id                 String              @id @default(cuid())
  userId             String              @map("user_id")
  kitchenId          String              @map("kitchen_id")
  total              Float
  status             OrderStatus         @default(PENDING)
  notes              String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  delivery_date      DateTime
  delivery_time_slot MealType?
  subscription_id    String?
  items              OrderItem[]
  kitchen            Kitchen             @relation(fields: [kitchenId], references: [id])
  user_subscriptions user_subscriptions? @relation(fields: [subscription_id], references: [id])
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews            Review[]

  @@index([userId])
  @@index([kitchenId])
  @@index([delivery_date, delivery_time_slot, kitchenId])
  @@index([subscription_id])
  @@map("orders")
}

model OrderItem {
  id         String     @id @default(cuid())
  orderId    String     @map("order_id")
  menuItemId String     @map("menu_item_id")
  quantity   Int
  price      Float
  menuItem   menu_items @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  order      Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([menuItemId])
  @@map("order_items")
}

model inventory_items {
  id               String   @id @default(cuid())
  chef_id          String
  name             String
  unit             String
  currentStock     Float    @default(0)
  demandFromOrders Float    @default(0)
  forecastDemand   Float    @default(0)
  reorderLevel     Float    @default(0)
  unitCost         Float    @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  users            User     @relation(fields: [chef_id], references: [id], onDelete: Cascade)

  @@index([chef_id])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String?          @map("user_id")
  kitchenId String?          @map("kitchen_id")
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  actionUrl String?          @map("action_url")
  kitchen   Kitchen?         @relation(fields: [kitchenId], references: [id], onDelete: Cascade)
  user      User?            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([kitchenId])
  @@index([read])
  @@map("notifications")
}

model Review {
  id         String     @id @default(cuid())
  userId     String     @map("user_id")
  menuItemId String     @map("menu_item_id")
  orderId    String     @map("order_id")
  rating     Int
  comment    String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  menuItem   menu_items @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  order      Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, menuItemId, orderId])
  @@index([userId])
  @@index([menuItemId])
  @@index([orderId])
  @@map("reviews")
}

model Favorite {
  id        String              @id @default(cuid())
  userId    String              @map("user_id")
  dishId    String?             @map("dish_id")
  kitchenId String?             @map("kitchen_id")
  planId    String?             @map("plan_id")
  createdAt DateTime            @default(now())
  dish      menu_items?         @relation(fields: [dishId], references: [id], onDelete: Cascade)
  kitchen   Kitchen?            @relation(fields: [kitchenId], references: [id], onDelete: Cascade)
  plan      subscription_plans? @relation(fields: [planId], references: [id], onDelete: Cascade)
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dishId])
  @@unique([userId, kitchenId])
  @@unique([userId, planId])
  @@index([userId])
  @@index([dishId])
  @@index([kitchenId])
  @@index([planId])
  @@map("favorites")
}

model user_subscriptions {
  id                   String             @id @default(cuid())
  userId               String             @map("user_id")
  planId               String             @map("plan_id")
  kitchenId            String             @map("kitchen_id")
  status               SubscriptionStatus @default(PENDING)
  startDate            DateTime           @map("start_date")
  endDate              DateTime?          @map("end_date")
  deliveryInstructions String?            @map("delivery_instructions")
  useChefContainers    Boolean            @default(true) @map("use_chef_containers")
  monthlyPrice         Float              @map("monthly_price")
  deliveryFee          Float              @default(0) @map("delivery_fee")
  discount             Float              @default(0)
  totalAmount          Float              @map("total_amount")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")
  confirmedAt          DateTime?          @map("confirmed_at")
  cancelledAt          DateTime?          @map("cancelled_at")
  cancellationReason   String?            @map("cancellation_reason")
  orders               Order[]
  kitchen              Kitchen            @relation(fields: [kitchenId], references: [id], onDelete: Cascade)
  plan                 subscription_plans @relation(fields: [planId], references: [id], onDelete: Cascade)
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([planId])
  @@index([kitchenId])
  @@index([status])
  @@map("user_subscriptions")
}

model SupportTicket {
  id          String              @id @default(cuid())
  userId      String?             @map("user_id")
  topic       String
  orderNumber String?             @map("order_number")
  message     String
  status      SupportTicketStatus @default(OPEN)
  adminReply  String?             @map("admin_reply")
  resolvedAt  DateTime?           @map("resolved_at")
  resolvedBy  String?             @map("resolved_by")
  created_at  DateTime            @default(now())
  updatedAt   DateTime            @updatedAt @map("updated_at")
  user        User?               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("support_tickets")
}

model AdminNotification {
  id              String                @id @default(cuid())
  supportTicketId String                @map("support_ticket_id")
  title           String
  message         String
  read            Boolean               @default(false)
  createdAt       DateTime              @default(now())
  type            AdminNotificationType @default(SUPPORT_TICKET)

  @@index([read])
  @@index([createdAt])
  @@index([type])
  @@map("admin_notifications")
}

enum Role {
  BUYER
  SELLER
  ADMIN
}

enum AuthProvider {
  EMAIL
  GOOGLE
}

enum DayOfWeek {
  SATURDAY
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
}

enum MealType {
  BREAKFAST
  LUNCH
  SNACKS
  DINNER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  DELIVERING
  COMPLETED
  CANCELLED
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  PAUSED
  CANCELLED
  COMPLETED
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum AdminNotificationType {
  SUPPORT_TICKET
  SELLER_APPROVAL
}
