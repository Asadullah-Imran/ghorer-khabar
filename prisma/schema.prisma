generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String        @id
  name               String?
  email              String        @unique
  password           String?
  phone              String?       @unique
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  role               Role          @default(BUYER)
  authProvider       AuthProvider  @default(EMAIL)
  avatar             String?
  emailVerified      Boolean       @default(false)
  providerId         String?
  resetToken         String?       @unique
  resetTokenExpiry   DateTime?
  verificationExpiry DateTime?
  verificationToken  String?       @unique
  addresses          Address[]
  EmailLogOTPs       EmailLogOTP[]
  menu_items         menu_items[]
  kitchens           Kitchen[]

  @@map("users")
}

model Address {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  label     String
  address   String
  zone      String?
  latitude  Float?
  longitude Float?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([latitude, longitude])
  @@map("addresses")
}

model EmailLogOTP {
  id        Int      @id @default(autoincrement())
  otp       String
  createdAt DateTime @default(now())
  expiresAt DateTime
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("forget_password_otps")
}

model ingredients {
  id           String     @id
  menu_item_id String
  name         String
  quantity     Float
  unit         String
  cost         Float?
  createdAt    DateTime   @default(now())
  menu_items   menu_items @relation(fields: [menu_item_id], references: [id], onDelete: Cascade)

  @@index([menu_item_id])
}

model menu_item_images {
  id           String     @id
  menu_item_id String
  imageUrl     String
  order        Int        @default(0)
  createdAt    DateTime   @default(now())
  menu_items   menu_items @relation(fields: [menu_item_id], references: [id], onDelete: Cascade)

  @@index([menu_item_id])
}

model menu_items {
  id               String             @id
  chef_id          String
  name             String
  description      String?
  category         String
  price            Float
  prepTime         Int?
  calories         Int?
  spiciness        String?
  isVegetarian     Boolean            @default(false)
  isAvailable      Boolean            @default(true)
  rating           Float?             @default(0)
  reviewCount      Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  ingredients      ingredients[]
  menu_item_images menu_item_images[]
  plan_schedules   plan_schedules[]
  users            User               @relation(fields: [chef_id], references: [id], onDelete: Cascade)

  @@index([chef_id])
}

enum Role {
  BUYER
  SELLER
  ADMIN
}

enum AuthProvider {
  EMAIL
  GOOGLE
}

model Kitchen {
  id                  String           @id @default(cuid())
  sellerId            String           @map("seller_id")
  name                String
  type                String?
  description         String?          @db.Text
  location            String?
  area                String?
  distance            Float?
  
  // NID Verification fields
  nidName             String?
  nidFrontImage       String?
  nidBackImage        String?
  
  // Onboarding status
  onboardingCompleted Boolean          @default(false)
  isVerified          Boolean          @default(false)
  isActive            Boolean          @default(true)
  isOpen              Boolean          @default(true)
  
  // Images
  coverImage          String?
  profileImage        String?
  
  // Metrics
  kriScore            Int              @default(0)
  rating              Decimal?         @default(0) @db.Decimal(3,2)
  reviewCount         Int              @default(0)
  totalOrders         Int              @default(0)
  totalRevenue        Decimal?         @default(0) @db.Decimal(10,2)
  satisfactionRate    Decimal?         @db.Decimal(3,2)
  responseTime        Int?
  deliveryRate        Decimal?         @db.Decimal(3,2)
  operatingDays       Json?
  
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  
  // Relations
  seller              User                @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  gallery             KitchenGallery[]
  subscription_plans  subscription_plans[]
  
  @@index([sellerId])
  @@map("kitchens")
}

model KitchenGallery {
  id         String   @id @default(cuid())
  kitchenId  String   @map("kitchen_id")
  imageUrl   String   @map("image_url")
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  
  kitchen    Kitchen  @relation(fields: [kitchenId], references: [id], onDelete: Cascade)
  
  @@index([kitchenId])
  @@map("kitchen_gallery")
}

enum DayOfWeek {
  SATURDAY
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
}

enum MealType {
  BREAKFAST
  LUNCH
  SNACKS
  DINNER
}

model subscription_plans {
  id                String              @id @default(cuid())
  kitchen_id        String              @map("kitchen_id")
  name              String
  description       String?
  price             Float
  meals_per_day     Int                 @default(1)
  servings_per_meal Int                 @default(1)
  is_active         Boolean             @default(true)
  subscriber_count  Int                 @default(0)
  monthly_revenue   Float               @default(0)
  
  rating            Decimal?            @default(0) @db.Decimal(3, 2)
  cover_image       String?             @map("cover_image")
  calories          Int?
  protein           String?
  carbs             String?
  fats              String?
  chef_quote        String?             @map("chef_quote")
  
  created_at        DateTime            @default(now()) @map("created_at")
  updated_at        DateTime            @updatedAt @map("updated_at")
  
  kitchen           Kitchen             @relation(fields: [kitchen_id], references: [id], onDelete: Cascade)
  plan_schedules    plan_schedules[]

  @@index([kitchen_id])
  @@map("subscription_plans")
}

model plan_schedules {
  id                String              @id @default(cuid())
  plan_id           String              @map("plan_id")
  day_of_week       DayOfWeek           @map("day_of_week")
  meal_type         MealType            @map("meal_type")
  time              String              @map("time")
  
  dish_id           String?             @map("dish_id")
  dish_name         String              @map("dish_name")
  dish_desc         String?             @map("dish_desc")
  image_url         String?             @map("image_url")
  
  created_at        DateTime            @default(now()) @map("created_at")
  updated_at        DateTime            @updatedAt @map("updated_at")

  subscription_plan subscription_plans  @relation(fields: [plan_id], references: [id], onDelete: Cascade)
  menu_item         menu_items?         @relation(fields: [dish_id], references: [id], onDelete: SetNull)

  @@index([plan_id])
  @@index([dish_id])
  @@unique([plan_id, day_of_week, meal_type, dish_id])
  @@map("plan_schedules")
}
